# ì„¼ì„œ ìƒíƒœ í™•ì¸ (0 = ë¬¸ ì—´ë¦¼, 1 = ë¬¸ ë‹«import network
import network
import socket
from machine import Pin, PWM
from neopixel import NeoPixel
from time import sleep, localtime

# ì™€ì´íŒŒì´ ì„¤ì •
SSID = 'Multi_2G'
PASSWORD = '12345678'

# í•˜ë“œì›¨ì–´ ì„¤ì •
servo = PWM(Pin(15), freq=50)
np = NeoPixel(Pin(14), 12)
door_sensor = Pin(13, Pin.IN, Pin.PULL_UP)  # GPIO13ì— ë¬¸ ì„¼ì„œ ì—°ê²° (í•„ìš”ì‹œ í•€ ë²ˆí˜¸ ë³€ê²½)
led = Pin(2, Pin.OUT)  # GPIO2ì— LED ì—°ê²° (í•„ìš”ì‹œ í•€ ë²ˆí˜¸ ë³€ê²½)
buzzer = PWM(Pin(4), freq=1000, duty=0)  # GPIO4ì— í”¼ì—ì¡° ìŠ¤í”¼ì»¤ ì—°ê²° (í•„ìš”ì‹œ í•€ ë²ˆí˜¸ ë³€ê²½)

# ë¡œê·¸ ì €ì¥ ë¦¬ìŠ¤íŠ¸
door_logs = []

# ì„œë³´ëª¨í„° ê°ë„ ì„¤ì • í•¨ìˆ˜
def set_angle(angle):
    duty = int(26 + (angle / 180) * 102)
    servo.duty(duty)

# ë„¤ì˜¤í”½ì…€ ìƒ‰ìƒ ì„¤ì • í•¨ìˆ˜
def set_neopixel_color(r, g, b):
    for i in range(12):
        np[i] = (r, g, b)
    np.write()

# ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ (ë” í° ì†Œë¦¬ë¡œ ë³€ê²½)
def play_beep():
    buzzer.freq(2000)  # ì£¼íŒŒìˆ˜ë¥¼ ë†’ì—¬ì„œ ë” ì˜ ë“¤ë¦¬ê²Œ
    buzzer.duty(1023)  # dutyë¥¼ ìµœëŒ€ë¡œ (ë” í° ì†Œë¦¬)
    sleep(0.3)  # ì¡°ê¸ˆ ë” ê¸¸ê²Œ
    buzzer.duty(0)
def get_time_str():
    t = localtime()
    return "{:04d}-{:02d}-{:02d} {:02d}:{:02d}:{:02d}".format(
        t[0], t[1], t[2], t[3], t[4], t[5])

# ë¡œê·¸ ì¶”ê°€
def add_log(status):
    time_str = get_time_str()
    door_logs.append({"time": time_str, "status": status})
    if len(door_logs) > 50:  # ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ì €ì¥
        door_logs.pop(0)
    print("{} - {}".format(time_str, status))

# ë¬¸ ì—´ê¸°
def open_door():
    set_angle(90)
    set_neopixel_color(0, 255, 0)
    print("ë¬¸ ì—´ë¦¼ (ì„œë³´ëª¨í„°)")

# ë¬¸ ë‹«ê¸°
def close_door():
    set_angle(0)
    set_neopixel_color(255, 0, 0)
    print("ë¬¸ ë‹«í˜ (ì„œë³´ëª¨í„°)")

# ì™€ì´íŒŒì´ ì—°ê²°
wifi = network.WLAN(network.STA_IF)
wifi.active(True)
wifi.connect(SSID, PASSWORD)

while not wifi.isconnected():
    sleep(1)

print("Connected to", SSID)
print("IP Address:", wifi.ifconfig()[0])

# HTML í…œí”Œë¦¿
HTML_TEMPLATE = """<!DOCTYPE HTML>
<html>
<head>
    <title>ESP32 Door Control</title>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="5">
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background-color: #f0f0f0; }}
        .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }}
        h2 {{ color: #333; text-align: center; }}
        .button {{ border: none; color: white; padding: 15px 30px; text-align: center;
                  text-decoration: none; display: inline-block; font-size: 16px; 
                  margin: 5px; cursor: pointer; border-radius: 8px; }}
        .button-open {{ background-color: #4CAF50; }}
        .button-close {{ background-color: #f44336; }}
        .status {{ text-align: center; margin: 20px 0; font-size: 20px; font-weight: bold; }}
        .logs {{ margin-top: 30px; }}
        .logs h3 {{ color: #333; }}
        .log-item {{ padding: 8px; margin: 5px 0; background: #f9f9f9; border-left: 4px solid #333; }}
        .log-open {{ border-left-color: #4CAF50; }}
        .log-close {{ border-left-color: #f44336; }}
        .controls {{ text-align: center; margin: 20px 0; }}
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸšª ESP32 ë„ì–´ ì œì–´ ì‹œìŠ¤í…œ</h2>
        <div class="status">í˜„ì¬ ìƒíƒœ: {state}</div>
        <div class="controls">
            <form style="display: inline;">
                <button type="submit" name="DOOR" value="OPEN" class="button button-open">ë¬¸ ì—´ê¸°</button>
                <button type="submit" name="DOOR" value="CLOSE" class="button button-close">ë¬¸ ë‹«ê¸°</button>
            </form>
        </div>
        <div class="logs">
            <h3>ğŸ“‹ ë¬¸ ê°œí ë¡œê·¸</h3>
            {logs}
        </div>
    </div>
</body>
</html>"""

# ì´ˆê¸° ìƒíƒœ: ë¬¸ ë‹«í˜
close_door()
door_state = 'ë‹«í˜ ğŸ”´'
previous_sensor_state = door_sensor.value()

# ì›¹ì„œë²„ ì‹œì‘
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.settimeout(0.5)  # 0.5ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
s.bind(('', 80))
s.listen(5)

print("ì›¹ì„œë²„ ì‹œì‘ë¨")

while True:
    # ì„¼ì„œ ìƒíƒœ í™•ì¸ (0 = ë¬¸ ì—´ë¦¼, 1 = ë¬¸ ë‹«í˜, PULL_UP ì‚¬ìš©ì‹œ)
    current_sensor_state = door_sensor.value()
    
    if current_sensor_state != previous_sensor_state:
        if current_sensor_state == 0:  # ë¬¸ ì—´ë¦¼ ê°ì§€
            add_log("DOOR OPEN")
            door_state = 'ì—´ë¦¼ ğŸŸ¢ (ì„¼ì„œ ê°ì§€)'
            led.value(0)  # LED ë„ê¸° (ë¬¸ ì—´ë¦¼)
            play_beep()  # ì†Œë¦¬ ì¬ìƒ (ë¬¸ ì—´ë¦´ ë•Œ)
        else:  # ë¬¸ ë‹«í˜ ê°ì§€
            add_log("DOOR CLOSE")
            door_state = 'ë‹«í˜ ğŸ”´ (ì„¼ì„œ ê°ì§€)'
            led.value(1)  # LED ì¼œê¸° (ë¬¸ ë‹«í˜)
        previous_sensor_state = current_sensor_state
    
    # ì›¹ ìš”ì²­ ì²˜ë¦¬
    try:
        conn, addr = s.accept()
        request = conn.recv(1024).decode()
        
        if '?DOOR=OPEN' in request:
            open_door()
            door_state = 'ì—´ë¦¼ ğŸŸ¢'
            add_log("DOOR OPEN (ì›¹ ëª…ë ¹)")
        elif '?DOOR=CLOSE' in request:
            close_door()
            door_state = 'ë‹«í˜ ğŸ”´'
            add_log("DOOR CLOSE (ì›¹ ëª…ë ¹)")
        
        # ë¡œê·¸ HTML ìƒì„±
        logs_html = ""
        for log in reversed(door_logs):
            log_class = "log-open" if "OPEN" in log["status"] else "log-close"
            logs_html += '<div class="log-item {}">{} - {}</div>'.format(
                log_class, log["time"], log["status"])
        
        if not logs_html:
            logs_html = '<div class="log-item">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
        
        response = HTML_TEMPLATE.format(state=door_state, logs=logs_html)
        conn.send('HTTP/1.1 200 OK\r\n')
        conn.send('Content-Type: text/html; charset=utf-8\r\n')
        conn.send('Connection: close\r\n\r\n')
        conn.sendall(response)
        conn.close()
    except OSError:
        pass  # íƒ€ì„ì•„ì›ƒ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
